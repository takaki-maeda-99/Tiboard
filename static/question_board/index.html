{% extends "base.html" %}{% load static %}

{% block title %}Question Board{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'widgets_test/common_style.css' %}">
<!-- <link rel="stylesheet" type="text/css" href="{% static 'question_board/styles.css' %}"> -->
<link rel="stylesheet" type="text/css" href="{% static 'widgets_test/sidebar_func.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'widgets_test/thread_func.css' %}">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script src="{% static 'widgets_test/common_script.js' %}"></script>
<script src="{% static 'widgets_test/sidebar_func.js' %}"></script>
<script src="{% static 'widgets_test/thread_func.js' %}"></script>

{% endblock %}

{% block head_bar_main %}
{% endblock %}

{% block content_side %}
<!-- ---------------------------------------------------------------------------------------------------- -->
<div id="sideber"></div>
<!-- ---------------------------------------------------------------------------------------------------- -->

{%endblock%}


{% block content_main %}

<div id="chat-container">
    <!-- メッセージ表示エリア -->
</div>

<!-- 入力欄と送信ボタン -->
{% csrf_token %}
<div id="input-container-backarea"></div>
<div id="input-container">
    <div id="reply-to">
        <p>≫<span id="reply-to-post"></span></p>
    </div>
    <textarea id="message-input" placeholder="メッセージを入力..."></textarea>
    <button id="upload-button" type="button">
        <i class="bi bi-paperclip"></i>
    </button>
    <button id="send-button" type="button">
        <i class="bi bi-send"></i>
    </button>
</div>

<script>

document.addEventListener('DOMContentLoaded', () => {
        
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const contentMain = document.getElementById('content-main');

    const inputContainerBackarea = document.getElementById('input-container-backarea');
    var beforeHeight = messageInput.scrollHeight;

    // メッセージ入力欄の高さを自動調整
    messageInput.addEventListener('input', () => {
        messageInput.style.height = '24px';
        messageInput.style.height = `${messageInput.scrollHeight}px`;
        inputContainerBackarea.style.height = `${messageInput.scrollHeight + 150 -24}px`;

        // 高さの変化量を計算してスクロール
        const diff = messageInput.scrollHeight - beforeHeight;

        contentMain.scrollBy({
            top: diff, // 縦方向にスクロール
            left: 0,  // 横方向にはスクロールしない
            behavior: 'smooth' // スムーズなスクロール
        });

        beforeHeight = messageInput.scrollHeight;
    });

    // 送信ボタンのクリックイベント
    sendButton.addEventListener('click', () => {
        const messageText = messageInput.value.trim(); // メッセージの内容を取得
        messageInput.value = ''; // メッセージ入力欄を空にする
        messageInput.style.height = '24px'; // メッセージ入力欄の高さをリセット
        inputContainerBackarea.style.height = '150px'; // メッセージ入力欄の高さをリセット
        beforeHeight = 16;

        const replyTo = document.getElementById('reply-to'); // 返信先の表示を消す
        replyTo.style.display = 'none';
        const replyToPost = document.getElementById('reply-to-post'); // 返信先のユーザー名を取得

        const post_data = { 
            "thread": thread_id,
            "content": messageText,
            "reply_to": replyToPost.innerText,
            "author__id": "anonymous",
        };

        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        post_url = "{% url 'guilds:question_board:post_post' %}"

        url = "{% url 'guilds:question_board:get_thread' 0 %}".replace("0", thread_id)

        fetch(post_url, {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken, // CSRFトークンをヘッダーに追加
            },
        body: JSON.stringify(post_data), // データを JSON 文字列に変換
        })
        .then((response) => {
            if (!response.ok) {
                throw new Error("Network response was not ok " + response.statusText);
            }
            return response.json(); // レスポンスを JSON としてパース
        })
        .then((responseData) => {
            console.log("Success:", responseData);
            fetch(url).then((response) => {
            if (!response.ok) {
                throw new Error("Network response was not ok " + response.statusText);
            }
            return response.json(); // レスポンスを JSON としてパース
            })
            .then((responseData) => {
                console.log("Success:", responseData.thread);
                createThread(responseData.thread);
            })
        })
        .catch((error) => {
            console.error("Error:", error);
        });
    }); 
});

</script>

{% endblock %}


{% block other_content %}

<script>
    fetch("thread_list/").then(response => response.json()).then(data => {
        console.log("aaa");
        threads = data.threads;
        const dics = threads.map(thread => {
            return {
                "mainText": thread.name,
                "subText": thread.description,
                "link": "{% url 'guilds:question_board:get_thread' 0 %}".replace("0", thread.id)
            };
        });
        createSidebar("sideber", dics, "Threads", true);
    });
</script>

{% endblock %}