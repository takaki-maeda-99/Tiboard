{% extends "../base.html" %} {% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }
        
        .gantt-chart {
            display: flex;
            overflow-x: scroll;
            white-space: nowrap;
            padding: 30px;
            height: fit-content;
            margin-bottom: 60px;
        }
        
        .tasks {
            display: flex;
            flex-direction: column;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .task-name {
            text-align: center;
            width: 150px;
            text-align: right;
            margin: 10px 0;
            height: 16px;
        }
        
        .chart {
            position: relative;
            min-width: fit-content;
        }
        
        .chart-header {
            display: flex;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            border-bottom: 1px solid #ccc;
            height: 36px;
        }
        
        .chart-header div {
            width: 60px;
            text-align: center;
            font-size: 12px;
            position: relative;
            margin: 10px 0;
        }
        
        .chart-footer {
            position: relative;
            height: 36px;
            margin-top: 10px;
            background-color: #fff;
            border-top: 1px solid #ccc;
            z-index: 5;
        }
        
        .chart-footer .date-label {
            position: absolute;
            text-align: center;
            font-size: 12px;
            line-height: 36px; /* 高さを中央揃えにするため */
            height: 100%;
        }
        
        .chart-footer .date-line {
            position: absolute;
            height: 100%;
            width: 1px;
            background-color: #ddd;
        }
        
        .task-bars {
            position: relative;
        }
        
        .task-bar {
            position: absolute;
            margin: 3px 0;
            height: 30px;
            background-color: rgba(76, 175, 80, 1);
            border-radius: 10px;
        }
        
        .vertical-line {
            position: absolute;
            top: 0;
            width: 1px;
            background-color: #ddd;
        }
        
    </style>
</head>

<body>
    <!-- ガントチャートを表示する部分 -->
    <div class="gantt-chart">
        <div class="tasks">
            <div class="task-name"><br></div>
        </div>
        <div class="chart">
            <div id="chart-header" class="chart-header"></div>
            <div id="task-bars" class="task-bars"></div>
            <div id="chart-footer" class="chart-footer"></div>
            <div id="current-time-line" class="current-time-line"></div>
        </div>
    </div>

    <script>
        async function fetchData(url) {
            try {
                // fetchリクエストを実行
                const response = await fetch(`/task_board/${url}`);

                // レスポンスをJSON形式に変換
                const data = await response.json();

                return data;

            } catch (error) {
                // エラーが発生した場合は、エラーメッセージをコンソールに表示
                console.error("Error:", error);

                return { error: error };
            }

        }

        // ガントチャートの描画
        document.addEventListener('DOMContentLoaded', function() {
            async function get_tasks(){
                const courses = await fetchData("update_courses/");
                const coursework = await fetchData("update_coursework/");
                // タスク配列を作成
                const tasks = coursework.map(works => {
                    return works.map(work => {
                        const { course_id_id, coursework_id, coursework_title, description, due_time, id, link, materials, update_time} = work;

                        // 期限の開始時刻（更新時間とおなじ）
                        const startTime = new Date(update_time).toISOString();
                        
                        // courseworkと同じcourse_idが含まれるcourseを取得
                        const target_dic = courses.find(item => item.id == course_id_id);

                        // course_titleを取得
                        const course_title = target_dic.course_name;

                        return {
                            name: `${course_title} ${coursework_title}`,
                            startTime: startTime,
                            endTime: due_time
                        };
                    });
                });
                const flattend_tasks = tasks.flat()
                return flattend_tasks
            }
            
            (async () => {
                const tasks = await get_tasks();
                console.log("tasks:", tasks);

                const chartHeader = document.getElementById('chart-header');
                const taskBars = document.getElementById('task-bars');
                const tasksContainer = document.querySelector('.tasks');
                const chartFooter = document.getElementById('chart-footer');
            
                const now = new Date();
                const startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
            
                // 横軸の範囲は3日間
                const daysRange = 3; // 表示する日数
                const hoursPerDay = 24; // 1日あたりの時間
                const hourToPx = 20; // 1時間当たりのpx
                const max_px = daysRange * hoursPerDay * hourToPx; // チャートの右端までのpx
            
                // 時間をピクセルに変換する関数
                function timeToPixels(time) {
                    const date = new Date(time);
                    const timeDiff = date - startDate;

                    // 時間差が負の場合（タスク開始前の場合）は0に設定
                    if (timeDiff < 0) return -30; // 日をまたいでいても左端から表示されるようにする
            
                    return (timeDiff / (1000 * 60 * 60)) * hourToPx; // ミリ秒を時間に変換してピクセルに変換
                }
            
                // 横軸を生成
                for (let day = 0; day < daysRange; day++) {
                    for (let hour = 0; hour < hoursPerDay; hour += 3) { // 3時間ごとの目盛り
                        const headerCell = document.createElement('div');
                        const date = new Date(startDate.getTime());
                        date.setDate(startDate.getDate() + day);
                        date.setHours(hour, 0, 0, 0);
            
                        headerCell.style.width = '60px'; // 縦線の幅に合わせる
                        headerCell.style.textAlign = 'center';
                        headerCell.style.position = 'relative'; // 相対位置を設定
                        headerCell.style.boxSizing = 'border-box'; // ボックスサイズを調整
                        headerCell.textContent = date.getHours() + ':00'; // 時間を表示
            
                        chartHeader.appendChild(headerCell);
                    }
                }
            
                // タスク名を動的に追加
                const margin = 10;
                const name_height = 16;
            
                tasks.forEach(task => {
                    const taskNameDiv = document.createElement('div');
                    taskNameDiv.className = 'task-name';
                    taskNameDiv.style.marginTop = `${margin}px`;
                    taskNameDiv.style.marginBottom = `${margin}px`;
                    taskNameDiv.style.height = `${name_height}px`;
                    taskNameDiv.textContent = task.name;
                    tasksContainer.appendChild(taskNameDiv);
                });
            
                // タスクバーを追加
                const taskSpacing = margin * 2 + name_height; // タスクバーの描画頻度
            
                // 縦線を先に追加しておく
                for (let i = 0; i < chartHeader.children.length; i++) {
                    const verticalLine = document.createElement('div');
                    verticalLine.className = 'vertical-line';
                    verticalLine.style.left = `${30 + i * 60}px`;
                    verticalLine.style.position = 'absolute';
                    verticalLine.style.top = '0';
                    verticalLine.style.bottom = '0';
                    verticalLine.style.width = '1px';
                    verticalLine.style.backgroundColor = '#ddd';
                    verticalLine.style.zIndex = '0'; // 縦線を最背面に
                    taskBars.appendChild(verticalLine);
                }
            
                tasks.forEach((task, index) => {
                    const taskBar = document.createElement('div');
                    taskBar.className = 'task-bar';
            
                    const taskStartPx = timeToPixels(task.startTime) + 30;
                    const taskEndPx = timeToPixels(task.endTime) + 30;
            
                    taskBar.style.left = `${taskStartPx}px`;
                    taskBar.style.width = `${taskEndPx - taskStartPx}px`;
                    taskBar.style.top = `${index * taskSpacing}px`; // タスクバーの上下の間隔を設定
                    taskBar.style.zIndex = '1'; // タスクバーを縦線より前面に
            
                    if (taskEndPx > max_px){ // 期限が表示されている日付よりも後の場合、右端に合わせる
                        taskBar.style.width = `${max_px - taskStartPx}px`;
                    };
            
                    // 期限の日付を表示するための div を作成
                    const dueDateDiv = document.createElement('div');
                    dueDateDiv.className = 'due-date';
                    const endDate = new Date(task.endTime);
            
                    // 日付を YYYY/MM/DD HH:MM の形式にフォーマット
                    dueDateDiv.textContent = endDate.toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                    }).replace(/\//g, '/'); // スラッシュで区切る
                    dueDateDiv.textContent = '~' + dueDateDiv.textContent
            
                    // 日付をタスクバーの左に寄せて上下中央に配置
                    dueDateDiv.style.position = 'absolute';
                    dueDateDiv.style.left = `${taskStartPx}px`;
                    dueDateDiv.style.marginLeft = '5px';
                    dueDateDiv.style.top = `${index * taskSpacing + 10}px`;
                    dueDateDiv.style.fontSize = '15px';
                    dueDateDiv.style.color = 'white';
                    dueDateDiv.style.zIndex = '2'; // 日付をタスクバーの上に表示
            
                    taskBars.appendChild(taskBar);
                    taskBars.appendChild(dueDateDiv);
            
                    // タスクごとに区切り線を追加
                    const separatorLine = document.createElement('div');
                    separatorLine.className = 'task-separator';
                    separatorLine.style.position = 'absolute';
                    separatorLine.style.top = `${(index + 1) * taskSpacing}px`; // 各タスクの下に線を追加
                    separatorLine.style.left = '0';
                    separatorLine.style.right = '0';
                    separatorLine.style.height = '1px';
                    separatorLine.style.backgroundColor = '#ccc';
                    taskBars.appendChild(separatorLine);
                });
            
                // 縦線追加の仕上げ
                const taskBarsHeight = taskBars.scrollHeight;
                const verticalLines = document.querySelectorAll('.vertical-line');
                verticalLines.forEach(line => {
                    line.style.height = `${taskBarsHeight}px`;
                });
            
                // 現在の時刻に赤い縦線を追加
                const nowPx = timeToPixels(now.toISOString());
                const nowLine = document.createElement('div');
                nowLine.style.position = 'absolute';
                nowLine.style.left = `${30 + nowPx}px`;
                nowLine.style.top = '0';
                nowLine.style.height = `${taskBarsHeight}px`;
                nowLine.style.width = '2px';
                nowLine.style.backgroundColor = 'red';
                nowLine.style.zIndex = '2'; // 現在の時刻の縦線をタスクバーの上に表示
            
                taskBars.appendChild(nowLine);
            
                // チャートの下部に日付を表示
                function createDateLabel(date, centerPx) {
                    const label = document.createElement('div');
                    label.className = 'date-label';
                    label.style.left = `${centerPx}px`;
                    label.style.width = '60px'; // 横幅に合わせて調整
                    label.textContent = date.toLocaleDateString('ja', { month: 'short', day: 'numeric' });
                    return label;
                }
            
                chartFooter.style.marginTop = `${taskBarsHeight}px`
            
                for (let day = 0; day < daysRange; day++) {
                    const date = new Date(startDate.getTime());
                    date.setDate(startDate.getDate() + day);
            
                    const centerPx = day * hourToPx * hoursPerDay + hourToPx * hoursPerDay / 2; // 日付ラベルの中央位置を設定
                    const leftPx = day * hourToPx * hoursPerDay; // 日付ラベルの左位置を設定
                    const dateLabel = createDateLabel(date, centerPx);
                    chartFooter.appendChild(dateLabel);
            
                    // 日付ラベルの真下に線を引く
                    const dateLine = document.createElement('div');
                    dateLine.className = 'date-line';
                    dateLine.style.left = `${leftPx + 30}px`; // ラベルの中央に線を引く
                    chartFooter.appendChild(dateLine);
                }
            })();
        });        

    </script>
</body>

{%endblock%}